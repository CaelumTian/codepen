<!DOCTYPE html>
<html lang="en">
<head>
    <title>SIPC codepen</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <link rel="stylesheet" href="./lib/styles/css/reset.css">
    <link rel="stylesheet" href="./lib/styles/css/base.css">
    <link rel="stylesheet" href="./lib/styles/css/editor.css">
</head>
<body class="layout-side editor">
    <header class="main-header">
        <div class="title-area">
            <a href="/" class="logo">
                <img src="./lib/images/logo.png" alt="">
            </a>
            <div class="title-text">
                <h1 id="pen-title">
                    <!-- 这里a放置该帖子的title -->
                    <a href="#">
                        SIPC Code
                    </a>
                </h1>
                <!-- 这里天用户名 -->
                <div class="by">该代码片段 by 田光宇</div>
            </div>
        </div>
        <div class="header-chunk">
            <button class="btn btn-insert">
                <i class="icon icon-cloud"></i>保存
            </button>
            <button class="btn">
                <i class="icon icon-setting"></i>设置
            </button>
            <button class="btn">
                <i class="icon icon-resize"></i>切换视图
            </button>
            <button class="btn">
                登录
            </button>
            <button class="btn">
                注册
            </button>
        </div>
    </header>
    <div class="page-wrap">
        <div class="code-box box-direction">
            <div class="top-boxes editor-box" id="editor">
                <div class="editor-resizer"></div>  <!-- HTML 控制条 -->
                <div id="box-html" class="box">
                    <div class="box-title">
                        <div class="box-handle" data-id=0></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>HTML</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="editor-resizer"></div>  <!-- CSS控制条 -->
                <div id="box-css" class="box">
                    <div class="box-title">
                        <div class="box-handle" id="css_handle" data-id=1></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>CSS</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="editor-resizer"></div>  <!-- JS控制条 -->
                <div id="box-js" class="box">
                    <div class="box-title">
                        <div class="box-handle" id="js_handle" data-id=2></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>JS</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 拖动条 -->
            <div id="resizer" class="resizer">
                <span></span>
                <div id="editor-width" class="editor-width">
                    210px
                </div>
            </div>
            <!-- 内容展示区 -->
            <div class="result-div result">

            </div>
        </div>
    </div>
    <footer class="site-footer">

    </footer>
    <script src="./lib/scripts/jquery-2.1.4.js"></script>
    <script>
        /*全局变量 sc */
        window.sc = {
            winSize : {
                "width" : window.innerWidth || $(document).innerWidth(),
                "height" : window.innerHeight || $(document).height()
            }
        };
        var bindResizer = (function() {
            var $resizer = $("#resizer"),           //拖动条
                    $showBlock = $("#editor-width"),
                    _resizeDirection,
                    _resizeRight = false,
                    _limitMin,
                    _limitMax,
                    _headerHeight,
                    ele_editor = document.getElementById("editor");           //编辑区
            var _minWidth = 216,
                    _minHeight = 125;
            var _disX, _disY;

            function _init() {
                $resizer.off();                 //清除全部事件
                _resizeDirection = $("body").hasClass("layout-top") ? "horizonal" : "vertical";     //判断方向
                _resizeRight = $("body").hasClass("layout-right") ? true : false;                  //左右颠倒
                _headerHeight = $("header").height();
                if(_resizeDirection === "vertical") {
                    _limitMax = sc.winSize.width - $resizer.width();
                    _limitMin = _minWidth;
                }else {
                    _limitMax = sc.winSize.height - $resizer.height();
                    _limitMin = _minHeight;
                }

                _runAction();
            }

            function _runAction() {
                $resizer.on("mousedown", function(event) {
                    event.preventDefault();     //必须清除全部事件
                    $showBlock.css({
                        "opacity" : 1
                    });
                    if(_resizeDirection === "vertical") {
                        _disX = event.pageX - $(event.target).offset().left;
                        var eleWidth = ele_editor.style.width;
                        ele_editor.style.width = eleWidth < _limitMin ? _limitMin :  eleWidth;
                        ele_editor.style.width = eleWidth > _limitMax ? _limitMax : eleWidth;
                    }else {
                        _disY = event.pageY - $(event.target).offset().top + 4;     //这里有4px微调，不知道为什么
                        var eleHeight = ele_editor.style.height;
                        ele_editor.style.height = eleHeight < _limitMin ? _limitMin :  eleHeight;
                        ele_editor.style.height= eleHeight > _limitMax ? _limitMax : eleHeight;
                    }
                    $(document).on("mousemove", resizeMove).on("mouseup", resizeEnd);    //添加两组事件
                })
            }

            function resizeMove(event) {
                event.preventDefault();
                if(_resizeDirection === "vertical") {
                    var dis = event.pageX;
                    if(_resizeRight) {
                        dis = sc.winSize.width - dis;
                    }
                    ele_editor.style.width = (dis - _disX) + "px";
                    $showBlock.text($(ele_editor).css("width"));
                }else {
                    var dis = event.pageY;
                    ele_editor.style.height = (dis - _headerHeight - _disY) + "px";
                    $showBlock.text($(ele_editor).css("height"));
                }
            }
            function resizeEnd(event) {
                $showBlock.css({
                    "opacity" : 0
                });
                $(document).off("mousemove", resizeMove).off("mouseup", resizeEnd);
            }

            //设置最小值
            function setMinValue(x, y) {
                _minWidth = x;
                _minHeight = y;
            }
            function _reset() {

            }
            return {
                init : _init,
                setMinValue : setMinValue
            }
        })();
        /*绑定代码区*/
        var bindBoxHandle = (function() {
            var $cssHandle = $("#css_handle"),
                    $jsHandle = $("#js_handle");
            var $boxHandle = $(".box-handle");
            var $boxes = $(".box"),                  //代码块，动态修改
                    $editor = $("#editor");          //代码块容器
            var _resizeDirection,
                    _editorContent,                  //容器空间
                    _minContent,                     //最小容器空间
                    $preEle,                         //前一个box元素
                    $curEle,                         //当前元素
                    $nextEle,
                    _headerHeight;
            var _resizerBorder = {
                "height" : 3
            };
            var _disX, _disY;
            function _init() {
                _headerHeight = $("header").height();
                _resizeDirection = $("body").hasClass("layout-top") ? "horizonal" : "vertical";     //判断方向
                if(_resizeDirection === "vertical") {
                    _editorContent = $editor.height();               //容器空间尺寸
                    var height = (_editorContent - 3 * _resizerBorder.height) / 3;
                    console.log(height);
                    _minContent = $cssHandle.height();
                    $boxes.css({
                        "height" : changePencent(height, _editorContent)
                    })
                }
                $boxHandle.on("mousedown", function(event) {
                    event.preventDefault();
                    _disY = event.pageY - $(event.target).offset().top;      //这几个计算务必注意
                    var $target = $(event.target);
                    var preIndex = parseInt($target.attr("data-id"));           //当前索引
                    $curEle = $($boxes[preIndex]);
                    $preEle = $($boxes[preIndex - 1]);
                    $nextEle = $($boxes[preIndex + 1]);
                    $(document).on("mousemove", handleMove).on("mouseup", handleUp);
                })
            }

            function handleMove(event) {
                event.preventDefault();
                var $target = $(event.target);
                if(_resizeDirection === "vertical") {
                    var topHeight = event.pageY - _headerHeight - _disY - 6;
                    var topPercent = changePencent(topHeight, _editorContent);
                    var extraPercent = changePencent(9, _editorContent);
                    console.log(extraPercent);
                    var curPercent = 100 - parseFloat($nextEle[0].style.height) - parseFloat(topPercent) - parseFloat(extraPercent);
                    console.log($nextEle.height());

                    $preEle.css({
                        "height" : topPercent
                    })
                    $curEle.css({
                        "height" : curPercent + "%"
                    })
                }
            }
            function handleUp(event) {
                $(document).off("mousemove", handleMove).off("mouseup", handleUp);
            }

            function changePencent(tval, cval) {
                return (tval / cval) * 100 + "%";
            }

            return {
                init : _init
            }
        })();
        jQuery(document).ready(function($) {
            bindResizer.init();
            bindBoxHandle.init();
        });

        /*浏览器窗口发生变化，重置所有内容*/
        $(window).on("resize", function() {
            console.log("重置");
            window.sc = {
                winSize : {
                    "width" : window.innerWidth || $(document).innerWidth(),
                    "height" : window.innerHeight || $(document).height()
                }
            };
            bindResizer.init();
        })
    </script>
</body>
</html>
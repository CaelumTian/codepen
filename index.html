<!DOCTYPE html>
<html lang="en">
<head>
    <title>SIPC codepen</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <link rel="stylesheet" href="./lib/scripts/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="./lib/scripts/codemirror/addon/scroll/simplescrollbars.css">
    <link rel="stylesheet" href="./lib/scripts/codemirror/theme/monokai.css">

    <link rel="stylesheet" href="./lib/styles/css/reset.css">
    <link rel="stylesheet" href="./lib/styles/css/base.css">
    <link rel="stylesheet" href="./lib/styles/css/editor.css">
</head>
<body class="layout-side editor">
    <header class="main-header">
        <div class="title-area">
            <a href="/" class="logo">
                <img src="./lib/images/logo.png" alt="">
            </a>
            <div class="title-text">
                <h1 id="pen-title">
                    <!-- 这里a放置该帖子的title -->
                    <a href="#">
                        SIPC Code
                    </a>
                </h1>
                <!-- 这里天用户名 -->
                <div class="by">该代码片段 by 田光宇</div>
            </div>
        </div>
        <div class="header-chunk">
            <button class="btn btn-insert">
                <i class="icon icon-cloud"></i>保存
            </button>
            <button class="btn">
                <i class="icon icon-setting"></i>设置
            </button>
            <button class="btn">
                <i class="icon icon-resize"></i>切换视图
            </button>
            <button class="btn">
                登录
            </button>
            <button class="btn">
                注册
            </button>
        </div>
    </header>
    <div class="page-wrap">
        <div class="code-box box-direction">
            <div class="top-boxes editor-box" id="editor">
                <div class="editor-resizer" data-id=0>
                   <h2 class="box-visual-title">
                      <span>HTML</span>
                   </h2>
                </div>  <!-- HTML 控制条 -->
                <div id="box-html" class="box">
                    <div class="box-title">
                        <div class="box-handle" data-id=0></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>HTML</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-wrap">
                        <textarea id="code-html"></textarea>
                    </div>
                </div>
                <div class="editor-resizer" data-id=1>
                    <h2 class="box-visual-title">
                        <span>CSS</span>
                    </h2>
                </div>  <!-- CSS控制条 -->
                <div id="box-css" class="box">
                    <div class="box-title">
                        <div class="box-handle" id="css_handle" data-id=1></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>CSS</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-wrap">
                        <textarea id="code-css"></textarea>
                    </div>
                </div>
                <div class="editor-resizer" data-id=2>
                    <h2 class="box-visual-title">
                        <span>JS</span>
                    </h2>
                </div>  <!-- JS控制条 -->
                <div id="box-js" class="box">
                    <div class="box-title">
                        <div class="box-handle" id="js_handle" data-id=2></div> <!-- 拖拽用 -->
                        <div class="box-action-left">
                            <h2>
                                <button class="btn small-btn btn-b-black">
                                    <i class="icon icon-setting"></i>
                                </button>
                                <span>JS</span>
                            </h2>
                        </div>
                        <div class="box-action-right">
                            <button class="btn small-btn btn-b-black">
                                <i class="icon icon-cancel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-wrap">
                        <textarea id="code-js"></textarea>
                    </div>
                </div>
            </div>
            <!-- 拖动条 -->
            <div id="resizer" class="resizer">
                <span></span>
                <div id="editor-width" class="editor-width">
                    210px
                </div>
            </div>
            <!-- 内容展示区 -->
            <div class="result-div result">
                <div class="iframe-hock"></div>
                <iframe src="./text.html" frameborder="0" class="result-iframe" id="aimIframe"></iframe>
            </div>
        </div>
    </div>
    <footer class="site-footer">

    </footer>
    <script src="./lib/scripts/codemirror/lib/codemirror.js"></script>
    <script src="./lib/scripts/codemirror/addon/scroll/simplescrollbars.js"></script>
    <script src="./lib/scripts/codemirror/addon/edit/closebrackets.js"></script>
    <script src="./lib/scripts/codemirror/addon/edit/closetag.js"></script>
    <script src="./lib/scripts/codemirror/addon/fold/xml-fold.js"></script>

    <script src="./lib/scripts/codemirror/mode/javascript/javascript.js"></script>
    <script src="./lib/scripts/codemirror/mode/css/css.js"></script>
    <script src="./lib/scripts/codemirror/mode/xml/xml.js"></script>
    <script src="./lib/scripts/codemirror/mode/htmlmixed/htmlmixed.js"></script>

    <script src="./lib/scripts/jquery-2.1.4.js"></script>
    <script>
        /*全局变量 sc */
        window.sc = {
            winSize : {
                "width" : window.innerWidth || $(document).innerWidth(),
                "height" : window.innerHeight || $(document).height()
            }
        };
        var bindResizer = (function() {
            var $resizer = $("#resizer"),           //拖动条
                    $showBlock = $("#editor-width"),
                    _resizeDirection,
                    _resizeRight = false,
                    _limitMin,
                    _limitMax,
                    _headerHeight,
                    ele_editor = document.getElementById("editor");           //编辑区
            var _minWidth = 216,
                    _minHeight = 125;
            var _disX, _disY;

            function _init() {
                $resizer.off();                 //清除全部事件
                _resizeDirection = $("body").hasClass("layout-top") ? "horizonal" : "vertical";     //判断方向
                _resizeRight = $("body").hasClass("layout-right") ? true : false;                  //左右颠倒
                _headerHeight = $("header").height();
                if(_resizeDirection === "vertical") {
                    _limitMax = sc.winSize.width - $resizer.width();
                    _limitMin = _minWidth;
                }else {
                    _limitMax = sc.winSize.height - $resizer.height();
                    _limitMin = _minHeight;
                }

                _runAction();
            }

            function _runAction() {
                $resizer.on("mousedown", function(event) {
                    event.preventDefault();     //必须清除全部事件
                    $showBlock.css({
                        "opacity" : 1
                    });
                    if(_resizeDirection === "vertical") {
                        _disX = event.pageX - $(event.target).offset().left;
                        var eleWidth = ele_editor.style.width;
                        ele_editor.style.width = eleWidth < _limitMin ? _limitMin :  eleWidth;
                        ele_editor.style.width = eleWidth > _limitMax ? _limitMax : eleWidth;
                    }else {
                        _disY = event.pageY - $(event.target).offset().top + 4;     //这里有4px微调，不知道为什么
                        var eleHeight = ele_editor.style.height;
                        ele_editor.style.height = eleHeight < _limitMin ? _limitMin :  eleHeight;
                        ele_editor.style.height= eleHeight > _limitMax ? _limitMax : eleHeight;
                    }
                    $(document).on("mousemove", resizeMove).on("mouseup", resizeEnd);    //添加两组事件
                })
            }

            function resizeMove(event) {
                event.preventDefault();
                if(_resizeDirection === "vertical") {
                    var dis = event.pageX;
                    if(_resizeRight) {
                        dis = sc.winSize.width - dis;
                    }
                    ele_editor.style.width = (dis - _disX) + "px";
                    $showBlock.text($(ele_editor).css("width"));
                }else {
                    var dis = event.pageY;
                    ele_editor.style.height = (dis - _headerHeight - _disY) + "px";
                    $showBlock.text($(ele_editor).css("height"));
                }
            }
            function resizeEnd(event) {
                $showBlock.css({
                    "opacity" : 0
                });
                $(document).off("mousemove", resizeMove).off("mouseup", resizeEnd);
                window.refresh();
            }

            //设置最小值
            function setMinValue(x, y) {
                _minWidth = x;
                _minHeight = y;
            }
            function _reset() {

            }
            return {
                init : _init,
                setMinValue : setMinValue
            }
        })();
        /*绑定代码区*/
        var bindBoxHandle = (function() {
            $cssHandle = $("#css_handle");
            var $boxHandle,
                    $boxes = $(".box"),             //代码块
                    $editor = $("#editor");		    //代码块容器
            var _resizerDirection,
                    _editorContent,                 //容器空间
                    _minRatio,                    //最小空间 (百分数)
                    _maxRatio,                    //最大空间 (百分数)
                    _extraRatio,                  //三条线，额外空间
                    _headerHeight,                  //头部高度
                    _diX,
                    _dixY,
                    $preEle,
                    $curEle,
                    $nextEle;
            var _resizerBorder = {             //修正边框
                "height" : 3,
                "width" : 20
            };
            function _init() {
                _headerHeight = $("header").height();
                _resizeDirection = $("body").hasClass("layout-top") ? "horizonal" : "vertical";     //判断方向
                if(_resizeDirection === "vertical") {
                    $boxHandle = $(".box-handle");
                    _editorContent = $editor.height();
                    _minRatio = $("#css_handle").height() / _editorContent;
                    _maxRatio = 1 - 2 * _minRatio;
                    _extraRatio = 9 / _editorContent;
                    $boxes.css({
                        "height" : changePercent((_editorContent - 3 * _resizerBorder.height) / 3, _editorContent)
                    })
                }else {
                    $boxHandle = $(".editor-resizer");    //横向
                    _editorContent = $editor.width();
                    _minRatio = 0;
                    _maxRatio = (_editorContent - 3 * _resizerBorder.width) / _editorContent;
                    _extraRatio = _resizerBorder.width * 3 / _editorContent;
                    $boxes.css({
                        "width" : changePercent((_editorContent - 3 * _resizerBorder.width) / 3, _editorContent)
                    })
                }

                $boxHandle.on("mousedown", function(event) {
                    event.preventDefault();
                    var $target = $(event.target),
                            index = parseInt($target.attr("data-id"));
                    $curEle = $($boxes[index]);
                    $preEle = $($boxes[index - 1]);
                    $nextEle = $($boxes[index + 1]);

                    if(_resizeDirection === "vertical") {
                        _disY = event.pageY - $target.offset().top;    //鼠标在边框上的距离
                    }else {
                        _disX = event.pageX - $target.offset().left;
                    }

                    $(document).on("mousemove", handleMove).on("mouseup", handleUp);
                })
            }

            function handleMove(event) {
                event.preventDefault();
                var $target = $(event.target);
                if(_resizeDirection === "vertical") {
                    if($nextEle.length !== 0) {   //说明选中的css
                        var topHeight = event.pageY - _headerHeight - _disY - 9;   //这里计算值是6？bug
                        var topRatio = topHeight / _editorContent;
                        topRatio = topRatio < _minRatio ? _minRatio : topRatio;
                        topRatio = topRatio > _maxRatio ? _maxRatio : topRatio;
                        var currRatio = 1 - topRatio - _extraRatio - parseFloat($nextEle[0].style.height) / 100;
                        if(currRatio < _minRatio) {
                            currRatio = _minRatio;      //这时是css部分，撞击js部分
                            var nextRatio = 1 - currRatio - topRatio - _extraRatio;
                            nextRatio = nextRatio < _minRatio ? _minRatio : nextRatio;

                            $nextEle.css({
                                "height" : changePercent(nextRatio)
                            })
                        }
                        $preEle.css({
                            "height" : changePercent(topRatio)
                        })
                        $curEle.css({
                            "height" : changePercent(currRatio)
                        })
                    }else {
                        var topHeight = event.pageY - _headerHeight - _disY - 6;   //这里计算值是6？bug
                        var currHeight = _editorContent - topHeight;
                        var $htmlEle = $($(".box")[0]);
                        var currRatio = currHeight / _editorContent;
                        currRatio = currRatio < _minRatio ? _minRatio : currRatio;
                        currRatio = currRatio > _maxRatio ? _maxRatio : currRatio;
                        var preRatio = 1 - currRatio - _extraRatio - parseFloat($htmlEle[0].style.height) / 100;
                        if(preRatio < _minRatio) {
                            preRatio = _minRatio;
                            var htmlRatio = 1 - currRatio - preRatio - _extraRatio;
                            htmlRatio = htmlRatio < _minRatio ? _minRatio : htmlRatio;
                            $htmlEle.css({
                                "height" : changePercent(htmlRatio)
                            })
                        }
                        $curEle.css({
                            "height" : changePercent(currRatio)
                        })
                        $preEle.css({
                            "height" : changePercent(preRatio)
                        })
                    }
                }else {
                    if($nextEle.length !== 0) {
                        var topWidth = event.pageX - _resizerBorder.width - _disX;
                        var topRatio = topWidth / _editorContent,
                                topRatio = topRatio < _minRatio ? _minRatio : topRatio,
                                topRatio = topRatio > _maxRatio ? _maxRatio : topRatio;
                        var currRatio = 1 - topRatio - _extraRatio - parseFloat($nextEle[0].style.width) / 100;
                        if(currRatio < _minRatio) {
                            currRatio = _minRatio;      //这时是css部分，撞击js部分
                            var nextRatio = 1 - currRatio - topRatio - _extraRatio;
                            nextRatio = nextRatio < _minRatio ? _minRatio : nextRatio;

                            $nextEle.css({
                                "width" : changePercent(nextRatio)
                            })
                        }
                        $preEle.css({
                            "width" : changePercent(topRatio)
                        })
                        $curEle.css({
                            "width" : changePercent(currRatio)
                        })
                    }else {
                        var topWidth = event.pageX + (_resizerBorder.width - _disX),
                                currWidth = _editorContent - topWidth;
                        var $htmlEle = $($(".box")[0]);
                        var currRatio = currWidth / _editorContent;

                        currRatio = currRatio < _minRatio ? _minRatio : currRatio;
                        currRatio = currRatio > _maxRatio ? _maxRatio : currRatio;

                        var preRatio = 1 - currRatio - _extraRatio - parseFloat($htmlEle[0].style.width) / 100;

                        if(preRatio < _minRatio) {
                            preRatio = _minRatio;
                            var htmlRatio = 1 - currRatio - preRatio - _extraRatio;
                            htmlRatio = htmlRatio < _minRatio ? _minRatio : htmlRatio;
                            $htmlEle.css({
                                "width" : changePercent(htmlRatio)
                            })
                        }
                        $curEle.css({
                            "width" : changePercent(currRatio)
                        })
                        $preEle.css({
                            "width" : changePercent(preRatio)
                        })
                    }
                    if($preEle.width() < 180) {
                        $preEle.prev().addClass("is-horiz");
                    }else {
                        $preEle.prev().removeClass("is-horiz");
                    }
                    if($curEle.width() < 180) {
                        $curEle.prev().addClass("is-horiz");
                    }else {
                        $curEle.prev().removeClass("is-horiz");
                    }
                    //这里用这个简直了，我醉了
                    try {
                        if($htmlEle.width() < 180) {
                            $htmlEle.prev().addClass("is-horiz");
                        }else{
                            $htmlEle.prev().removeClass("is-horiz");
                        }
                        if($nextEle.width() < 180) {
                            $nextEle.prev().addClass("is-horiz");
                        }else{
                            $nextEle.prev().removeClass("is-horiz");
                        }
                    }catch(e){}
                }
            }

            function handleUp(event) {
                $(document).off("mousemove", handleMove).off("mouseup", handleUp);
                window.refresh();
            }

            function changePercent() {
                if(arguments.length === 1) {
                    return arguments[0] * 100 + "%";
                }
                if(arguments.length === 2) {
                    return (arguments[0] / arguments[1]) * 100 + "%";
                }
            }

            return {
                init : _init
            }
        })();
        jQuery(document).ready(function($) {
            var mixedMode = {
                name: "htmlmixed",
                scriptTypes: [{matches: /\/x-handlebars-template|\/x-mustache/i,
                    mode: null},
                    {matches: /(text|application)\/(x-)?vb(a|script)/i,
                        mode: "vbscript"}]
            };
            var aimIframe = document.getElementById("aimIframe");
            var iframeDocument;
            var iframeBody;

            window.codeHtml = CodeMirror.fromTextArea(document.getElementById("code-html"), {
                lineNumbers: true,
                mode : mixedMode,
                scrollbarStyle : "overlay",
                theme : "monokai",
                lineWrapping: true,       //长文本换行
                smartIndent: false,
                autoCloseTags: true,
                autoCloseBrackets: true
            });

            window.codeCss = CodeMirror.fromTextArea(document.getElementById("code-css"), {
                lineNumbers: true,
                mode : "css",
                scrollbarStyle : "overlay",
                theme : "monokai",
                lineWrapping: true,       //长文本换行
                smartIndent: false,
                autoCloseTags: true,
                autoCloseBrackets: true
            });

            window.codeJs = CodeMirror.fromTextArea(document.getElementById("code-js"), {
                lineNumbers: true,
                mode : "javascript",
                scrollbarStyle : "overlay",
                theme : "monokai",
                lineWrapping: true,       //长文本换行
                smartIndent: false,
                autoCloseTags: true,
                autoCloseBrackets: true
            });


            window.refresh = function() {
                window.codeHtml.refresh();
                window.codeCss.refresh();
                window.codeJs.refresh();
            };

            $(".code-wrap").css({
                "visibility" : "visible"
            });

            bindResizer.init();
            bindBoxHandle.init();


            var cssTimeout;    //函数节流
            var htmlTimeout;

            window.codeCss.on("change", function(codeMirror, obj) {
                var doc = codeMirror.doc;
                iframeDocument = aimIframe.contentWindow.document;

                clearTimeout(cssTimeout);
                cssTimeout = setTimeout(function() {

                    var currStyle = document.createElement("style");
                    currStyle.id = "aimStyle";
                    currStyle.textContent = doc.getValue();
                    iframeDocument.getElementById("aimStyle").remove();    //删除这里

                    iframeDocument.head.appendChild(currStyle);
                }, 2000)
            });

            window.codeHtml.on("change", function(codeMirror, obj) {
                var doc = codeMirror.doc;
                iframeDocument = aimIframe.contentWindow.document;
                iframeBody = iframeDocument.body;

                clearTimeout(htmlTimeout);
                htmlTimeout = setTimeout(function() {
                    iframeBody.innerHTML = doc.getValue();
                    window.codeJs.triggerOnKeyDown("change");
                    window.codeCss.triggerOnKeyDown("change");
                }, 2000)
            });

            window.codeJs.on("change", function(codeMirror, obj) {
                console.log("发生改变");
                var doc = codeMirror.doc;
                iframeDocument = aimIframe.contentWindow.document;

                var currScript = document.createElement("script");
                currScript.id = "aimScript";
                currScript.textContent = "try{" + doc.getValue() + "}catch(e){}";   //捕获掉这里所有的异常
                try {
                    iframeDocument.getElementById("aimScript").remove();
                }catch(e){}
                iframeDocument.body.appendChild(currScript);

            })

        });

        /*浏览器窗口发生变化，重置所有内容*/
        $(window).on("resize", function() {
            console.log("重置");
            window.sc = {
                winSize : {
                    "width" : window.innerWidth || $(document).innerWidth(),
                    "height" : window.innerHeight || $(document).height()
                }
            };
            bindResizer.init();
        })
    </script>
</body>
</html>